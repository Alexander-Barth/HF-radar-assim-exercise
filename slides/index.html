<!DOCTYPE html>
<!--PDF export:

* set screen-resolution to 1024x768
* open index.html in google-chrome
* print to PDF
https://github.com/gnab/remark/issues/50


 -->
<html>
  <head>
    <title>HF radar assimilation exercise</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body {
          font-family: 'Droid Sans';
      }

      h1, h2, h3 {
        /*font-family: 'Droid Serif';*/
          font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
        color: rgb(0,56,201);
      }

      .center.middle h1 {
        color: rgb(0,156,146);
      }

      .remark-code, .remark-inline-code {
          font-family: 'Ubuntu Mono';
      }

      .titlepage p {
          margin: 5px;
      }

      strong {
        color: rgb(204,25,25);
      }

      img, video {
          margin: 5px;
          box-shadow: 3px 3px 5px 2px rgba(0,0,0,0.3);
      }

      img[alt^="logo"] {
          height: 60px;
          margin: 20px;
      }

      img[alt*="full:"] {
          width: 700px;
          float: right;
      }

      img[alt*="aneq:"] {
          width: 500px;
          float: right;
      }

      img[alt*="half:"] {
          width: 350px;
          float: right;
      }

      img[alt*="eof:"] {
          width: 450px;
          float: right;
      }

      img[alt*="nesting:"] {
          width: 500px;
          float: right;
      }

      img[alt*="twofig:"] {
          width: 360px;
      }

      table {
          border-collapse: collapse;
          margin: auto;
      }
      th, td {
          padding: 6px 13px;
          border: 1px solid #ccc;
      }
      table tr:nth-child(2n) {
          background-color: #f8f8f8;
      }

      img[alt*="right:"] {
          width: 500px;
          float: right;
      }


      .ms {
          color: red;
      }

      .obs {
          color: blue;
      }

      /* http://stackoverflow.com/questions/16311164/css-box-shadow-is-so-dark-when-printed*/
      @media print {
          img, video {
              box-shadow: none;
              -webkit-box-shadow: none;
          }
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle, titlepage

# HF radar assimilation exercise

Alexander Barth<sup>1</sup>, Solène Jousset<sup>2</sup>,


<sup>1</sup>University of Liege, Belgium
<sup>2</sup>SHOM, France

__ISSOR 2017__

http://tinyurl.com/assim-caen

![logo](Fig/logo_ulg2.svg)
![logo](Fig/GHER.svg)


---
# A quick introduction to Julia

https://github.com/Alexander-Barth/HF-radar-assim-caen/blob/master/Julia.md

---
# Ensemble generation

![half:](Fig/wind_ens.svg)
* 88 ROMS model runs with perturbed:
  * Boundary conditions
  * Wind forcing
  * Solar radiation
* Ensemble run is the most costly step
* For Ensemble OI: the ensemble is static taken from the time evolution of the model
* Ensemble state from different times
* Here: ensemble is from a free-running ensemble simulation
* In total 528 ensemble members

---
# Grid staggering

![right:](Fig/arakawa2.svg)
* ROMS uses the Arakawa C grid
* $u$ and $v$ velocities are not defined at the same location


---
# Interpolation of velocity

![right:](Fig/arakawa_C.svg)
* Velocity is interpolated to a common location
* Here: $u$ and $v$ are interpolated to the center of the grid
* For the $u$ component see figure


---
# Geometry
![right:](Fig/HF-radar.svg)
* Measurement location is characterized by the distance from the HF radar site and the bearing angle β.
* A single HF radar site measures the radial velocity relative to the direction α.


---
# Observation operator


* Implement the observation operator as the function `interp_radvel`
* Interpolation is implemented in the package `Interpolations`
* Assumes that the grid is aligned in the North-South and East-West directions (which is the case here)
* Example of interpolating the component `us` at the location 8°N and 43°W
```julia
using Interpolations
us = .... # surface current
itpu = interpolate((lon_u[:,1],lat_u[1,:]),us,Gridded(Linear()));
itpu[8,43]
```

* Suggestion: use an explicit loop for all observation locations

---
# Observation error covariance

* Observation error covariance `R` is assumed to be a diagonal matrix with all diagonal elements equal to 0.2 (m²/s²).
```julia
R = Diagonal(fill(0.2,size(yo)))
```

* Observations are perturbed by adding random noise.
```julia
yo = yo + sqrtm(R) * randn(size(yo))
```
* Set the seed to make the exercise exactly reproducible across different computers.
```julia
srand(12345)
```

---
# Data and code

* Open a terminal
* Copy the folder `/home/invites/data/ISSOR17/HF-radar-assim-caen` in your home directory (if not already present)
```bash
cp -R /home/invites/data/ISSOR17/HF-radar-assim-caen ~
```
* The tilde (~) means your home directory and the symbol is on same key as the digit 2 on a French keyboard
* Enter the directory `HF-radar-assim-caen` and start julia by typing:
```bash
cd HF-radar-assim-caen
julia
```
* Installed editors: gedit, emacs, vi


---
# Exercises

* Work in groups

1) Compute the __ensemble standard of the velocity vector__ as
$$\sqrt{ var(u) + var(v)}$$
Create a plot (x-axis is the longitude and y-axis is the latitude) and the color represents the ensemble standard.


2) What is the __probability__ that the speed (norm of the velocity vector) exceeds 20 cm/s assuming that the ensemble members are a sample of the model probability distribution function (pdf)?
Create a plot (x-axis is the longitude and y-axis is the latitude) and the color represents the probability

---
3) Simplified __twin experiment__:
   * Let's assume that the last ensemble member is the reality (true current)
   * The last ensemble member will be used to extract observations, but it will not be used during the analysis
   * Assimilate radial observations of two HF radar sites
   * Optimize the __position and orientation__ of two HF radar sites. We assume that the field of view of the HF Radar 120 degrees but the orientation of the antenna can be chosen freely. The range of HF radar is fixed to 100 km with a radial resolution of 5 km.
   * Validate the mean of the analysis ensemble with the true currents


---
# Submit results

* Start by adapting the file `assim_exercise.jl` which includes the ETKF analysis scheme and several utility functions
* Choose group name
* Submit your results using your group name and the the location and orientation of the 2 HF radar sites:
```julia
submit_results(groupname,sitelon1,sitelat1,siteorientation1,
  sitelon2,sitelat2,siteorientation2)
```
* View how well you are doing: http://data-assimilation.net/scores/?game=Caen
* You can run the function `submit_results` as many time as you want, but use always the same group name. Only the best result will appear.
* Still make sure that your placed your HF radar sites on land...

---
# Submit results

* Alternatively, load the script `submit_results.jl`

```julia
include("submit_results.jl");
```

Then
```julia
submit_results2("your group name",sitelon1,sitelat1,siteorientation1,
   sitelon2,sitelat2,siteorientation2,rms(xa,xt))
```

---
# Troubleshooting

* Before starting julia, you need to set

```bash
export JULIA_PKGDIR=/home/invites/data/ISSOR17/julia
```

* Double-check if julia version 0.6 is started (not version 0.4.5 which is also installed)
* You might need the full path:
```bash
/export/site/bin/julia06

* You can ignore warnings like "replacings docs for 'function name' in module Main"
```





    </textarea>
    <script src="remark-latest.min.js" type="text/javascript"></script>

    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
<!--
    <script src="MathJax-2.6-latest/MathJax.js?config=TeX-AMS_HTML&delayStartupUntil=configured" type="text/javascript"></script>
-->

    <script type="text/javascript">
      var slideshow = remark.create();

      // Setup MathJax
      MathJax.Hub.Config({
          tex2jax: {
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
            inlineMath: [['$','$'], ['\\(','\\)']],
            processEscapes: true
          },
          TeX: { extensions: ["color.js"] }
      });
      MathJax.Hub.Configured();

    </script>
  </body>
</html>

<!--  LocalWords:  Slideshow nd matlab argo whos Attr Tobs latobs UTC
 -->
<!--  LocalWords:  lonobs timeobs datenum datevec datestr colorbar nc
 -->
<!--  LocalWords:  caxis Outliers outliers Bathymetry GEBCO ncdisp pn
 -->
<!--  LocalWords:  bathymetry ncread lon ndgrid pcolor divand Tmean
 -->
<!--  LocalWords:  Tanom len moddim interpn isnan repmat po lentime
 -->
<!--  LocalWords:  clf dpng yyyy png outlier OceanBrowser url rgb px
 -->
<!--  LocalWords:  Kaffeesatz titlepage img rgba CDI situ Sylvain OGS
 -->
<!--  LocalWords:  Watelet Troupin Alvera Azcarate Giorgio Santinelli
 -->
<!--  LocalWords:  Gerrit Hendriksen Alessandra Giorgetti Beckers EPS
 -->
<!--  LocalWords:  GHER Liège SOCIB Deltares Variational gridded SMHI
 -->
<!--  LocalWords:  variational NetCDF SeaDataNet EMODNET Metadata SVG
 -->
<!--  LocalWords:  OPeNDAP Centred WebM revalidation distrib EDMO OGC
 -->
<!--  LocalWords:  oceanbrowser abarth localhost webm AGPL matplotlib
 -->
<!--  LocalWords:  WMS WFS twofig td ccc webkit parametrization Luc
 -->
<!--  LocalWords:  Vandenbulcke seamod ro subgrid parametrizations Fi
 -->
<!--  LocalWords:  ROMS Ligurian CMEMS EOF Laplacian nabla frac mbox
 -->
<!--  LocalWords:  biharm discretization altimetry mathbf covariance
 -->
<!--  LocalWords:  Smagorinsky biharmonic stdfit parametrized src eof
 -->


<!--  LocalWords:  Yanone submesoscale aneq Kalman Céline Taymans vec
 -->
<!--  LocalWords:  Azcárate newcommand tindex renewcommand underbrace
 -->
<!--  LocalWords:  advection ij boldsymbol discretized pdf Eulerian
 -->
<!--  LocalWords:  rightarrow forcings Navier Stoques cdot NCEP jj jl
 -->
<!--  LocalWords:  alignat linearized ETKF SAR Envisat Karimova VIIRS
 -->
<!--  LocalWords:  ECMWF CMRE LOGMEC Borrione Paolo Oddo Aniello OOV
 -->
<!--  LocalWords:  Coelho LOV MooseT upscaling NEMO coef Solène SHOM
 -->
<!--  LocalWords:  Jousset ISSOR Arakawa interp radvel julia itpu
 -->
<!--  LocalWords:  sqrtm randn srand sqrt assim groupname sitelon
 -->
<!--  LocalWords:  sitelat siteorientation
 -->
